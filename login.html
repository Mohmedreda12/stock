<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="login_title">تسجيل الدخول</title>

  <meta name="color-scheme" content="dark light" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="rtl app-body" data-page="login">
  <!-- الشريط العلوي (يحترم الترجمة والستايل العام) -->
  <header id="topbar"></header>

  <main class="container" style="max-width:480px">
    <div class="card" style="padding:24px">
      <h2 class="title" data-i18n="login_title" style="text-align:center;margin:0 0 18px">تسجيل الدخول</h2>

      <!-- صفوف تحت بعض -->
      <div class="form-col" style="display:flex;flex-direction:column;gap:14px">
        <div class="form-group" style="display:flex;flex-direction:column;gap:6px">
          <label class="label" for="user" data-i18n="login_user">المعرّف</label>
          <input id="user" class="input" autocomplete="username"
                 data-i18n-attr="placeholder:login_user" placeholder="المعرّف" required />
        </div>

        <div class="form-group" style="display:flex;flex-direction:column;gap:6px">
          <label class="label" for="pass" data-i18n="login_pass">كلمة السر</label>
          <input id="pass" class="input" type="password" autocomplete="current-password"
                 data-i18n-attr="placeholder:login_pass" placeholder="كلمة السر" required />
        </div>

        <button id="loginBtn" class="btn btn-primary" data-i18n="login_btn" style="margin-top:6px">
          دخول
        </button>

        <!-- رسالة الخطأ -->
        <p id="loginErr" class="error" style="margin:6px 0 0;color:#f87171;font-weight:700;display:none">
          .
        </p>
      </div>
    </div>
  </main>

  <!-- الترجمة + الشريط + الأكواد العامة للموقع -->
  <script defer src="i18n.js"></script>
  <script defer src="app.js"></script>

  <script>
    // مساعد ترجمة آمن سريع
    function t(key, fb = '') {
      try {
        const lang = (typeof getLang === 'function') ? getLang() : 'ar';
        const dict = (window.I18N && I18N[lang]) || {};
        return (dict[key] != null) ? dict[key] : (fb || key);
      } catch { return fb || key; }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // ارسم الشريط وطبّق الترجمة
      try { renderTopbar('login'); wireTopbar('login'); } catch {}
      try { applyStaticTexts?.(document); } catch {}

      // لو مسجّل بالفعل، روح الرئيسية
      try {
        if (window.isAuthed && window.isAuthed()) {
          location.replace('index.html');
          return;
        }
      } catch {}

      const $ = id => document.getElementById(id);
      const user = $('user');
      const pass = $('pass');
      const btn  = $('loginBtn');
      const err  = $('loginErr');

      // فوكس أول ما تفتح
      user?.focus();

      async function doLogin() {
        err.style.display = 'none';
        const u = (user.value || '').trim();
        const p = pass.value || '';

        if (!u || !p) {
          err.textContent = t('login_err', 'المعرّف أو كلمة السر غير صحيحة.');
          err.style.display = 'block';
          return;
        }

        try {
          const ok = await (window.login ? window.login(u, p) : Promise.resolve(false));
          if (ok) {
            location.replace('index.html');
          } else {
            err.textContent = t('login_err', 'المعرّف أو كلمة السر غير صحيحة.');
            err.style.display = 'block';
          }
        } catch (e) {
          err.textContent = t('login_err', 'المعرّف أو كلمة السر غير صحيحة.');
          err.style.display = 'block';
        }
      }

      btn?.addEventListener('click', doLogin);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') doLogin();
      });
    });
  </script>
</body>
</html>
